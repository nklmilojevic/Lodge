name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v2.7.0)"
        required: true
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-26
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
      DOWNLOAD_URL_PREFIX: https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Sparkle tools
        run: brew install sparkle

      - name: Import signing certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}

      - name: Prepare notarization key
        run: |
          echo "${{ secrets.NOTARY_KEY_P8 }}" | base64 -d > "$RUNNER_TEMP/AuthKey.p8"

      - name: Update export options team ID
        run: /usr/libexec/PlistBuddy -c "Set :teamID ${{ secrets.APPLE_TEAM_ID }}" scripts/export-options.plist

      - name: Build, sign, and notarize
        run: |
          chmod +x scripts/release.sh scripts/generate-appcast.sh
          NOTARY_KEY="$RUNNER_TEMP/AuthKey.p8" \
          NOTARY_KEY_ID="${{ secrets.NOTARY_KEY_ID }}" \
          NOTARY_ISSUER_ID="${{ secrets.NOTARY_ISSUER_ID }}" \
          scripts/release.sh

      - name: Prepare Sparkle private key
        run: |
          echo "${{ secrets.SPARKLE_PRIVATE_KEY }}" | base64 -d > "$RUNNER_TEMP/sparkle_ed_private"
          chmod 600 "$RUNNER_TEMP/sparkle_ed_private"

      - name: Generate appcast
        run: |
          SPARKLE_BIN="$(dirname "$(find "$(brew --prefix)/Caskroom/sparkle" -name generate_appcast -type f | head -1)")" \
            SPARKLE_PRIVATE_KEY="$RUNNER_TEMP/sparkle_ed_private" \
            DOWNLOAD_URL_PREFIX="$DOWNLOAD_URL_PREFIX" \
            scripts/generate-appcast.sh

      - name: Commit appcast to main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp appcast.xml "$RUNNER_TEMP/appcast.xml"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          cp "$RUNNER_TEMP/appcast.xml" appcast.xml
          git add appcast.xml
          git commit -m "Update appcast for $RELEASE_TAG"
          git push origin main

      - name: Create or update GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            gh release create "$RELEASE_TAG" --generate-notes
          fi
          gh release upload "$RELEASE_TAG" \
            build/Lodge.dmg \
            build/updates/Lodge.app.zip \
            appcast.xml \
            --clobber

      - name: Update Homebrew tap
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${RELEASE_TAG#v}"
          SHA256=$(shasum -a 256 build/updates/Lodge.app.zip | awk '{print $1}')

          gh repo clone nklmilojevic/homebrew-lodge "$RUNNER_TEMP/homebrew-lodge"
          cd "$RUNNER_TEMP/homebrew-lodge"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/nklmilojevic/homebrew-lodge.git"

          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/lodge.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/" Casks/lodge.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/lodge.rb
          git commit -m "Update Lodge to $VERSION"
          git push
